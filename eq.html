<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>three.js Graphic EQ</title>
    <style>
        body {
            /* set margin to 0 and overflow to hidden, to go fullscreen */
            margin: 0;
            overflow: hidden;
        }
        div#mp3_player{ width:500px; height:60px; background:#000; padding:5px; margin:50px auto; }
        div#mp3_player > div > audio{  width:500px; background:#000; float:left;  }
        div#mp3_player > canvas{ width:500px; height:30px; background:#002D3C; float:left; }
        div#container > canvas{ width:800px; height:600px; background:#ffffff; float:left; }
    </style>
</head>

<body>
    <script src="docs/libraries/three.js"></script>
    <script src="docs/libraries/OrbitControls.js"></script>
    <script src="docs/libraries/stats.js"></script>

    <div id="container">
    <div id="mp3_player">
    <div id="audio_box">
    </div>


<script type="text/javascript">
/*** base Graphic EQ code by srchea ***/

var camera, scene, renderer;
var controls;
var listener;
var document;
var audio = new Audio();

// Establish all variables that your Analyser will use
var source, mainContext, filterCtx, analyser, analysisCtx, bandFilter, freqBands;

scene = new THREE.Scene();

function audioElement(){
    // Create a new instance of an audio object and adjust some of its properties
    audio.src = "docs/00 - Cut Your Hair.mp3";
    audio.controls = true;
    audio.loop = true;
    audio.autoplay = true;

    mainContext = new (window.AudioContext || window.webkitAudioContext)();
    filterCtx = new (window.AudioContext || window.webkitAudioContext)();

    bandFilter = filterCtx.createBiquadFilter(); // BiquadFilterNode
    analyser = filterCtx.createAnalyser(); // AnalyserNode 
    analyser.fftSize = 256; //or 32768

    bufferDriver = mainContext.createBuffer(2, 1024, 44100);
    gainDriver = mainContext.createGain();

    // Re-route audio playback into the processing graph of the AudioContext
    source = mainContext.createMediaElementSource(audio);

    source0 = source;  //USE REG EXP TO ITERATE THROUGHT THIS
    bandFilter0 = bandFilter;
    source0.connect(bandFilter0);
    setBqFreqBand(9);
    analyser0 = analyser;
    bandFilter0.connect(analyser0);

    source1 = source;
    bandFilter1 = bandFilter;
    source1.connect(bandFilter1);
    setBqFreqBand(8);
    analyser1 = analyser;
    bandFilter1.connect(analyser1);

    source2 = source;
    bandFilter2 = bandFilter;
    source2.connect(bandFilter2);
    setBqFreqBand(7);
    analyser2 = analyser;
    bandFilter2.connect(analyser2);

    source3 = source;
    bandFilter3 = bandFilter;
    source3.connect(bandFilter3);
    setBqFreqBand(6);
    analyser3 = analyser;
    bandFilter3.connect(analyser3);

    source4 = source;
    bandFilter4 = bandFilter;
    source4.connect(bandFilter4);
    setBqFreqBand(5);
    analyser4 = analyser;
    bandFilter4.connect(analyser4);

    source5 = source;
    bandFilter5 = bandFilter;
    source5.connect(bandFilter5);
    setBqFreqBand(4);
    analyser5 = analyser;
    bandFilter5.connect(analyser5);

    source6 = source;
    bandFilter6 = bandFilter;
    source6.connect(bandFilter6);
    setBqFreqBand(3);
    analyser6 = analyser;
    bandFilter6.connect(analyser6);

    source7 = source;
    bandFilter7 = bandFilter;
    source7.connect(bandFilter7);
    setBqFreqBand(2);
    analyser7 = analyser;
    bandFilter7.connect(analyser7);

    source8 = source;
    bandFilter8 = bandFilter;
    source8.connect(bandFilter8);
    setBqFreqBand(1);
    analyser8 = analyser;
    bandFilter8.connect(analyser8);

    source9 = source;
    bandFilter9 = bandFilter;
    source9.connect(bandFilter9);
    setBqFreqBand(0);
    analyser9 = analyser;
    bandFilter9.connect(analyser9);

    source.connect(bufferDriver);
    bufferDriver.connect(gainDriver);
    gainDriver.connect(mainContext.destination);
    gainDriver.gain.setValueAtTime(0.667, mainContext.currentTime);
    //return analyser;
}

function getBqFreqBands(k){
    // Set the number of frequency bands for the EQ
    var freqBands = new Float32Array(10);
    //freqBands[0] = 0;  //Placeholder for ease of iteration above
    if (k == 0) {
        freqBands[k] = 31.25; } 
    else {
        freqBands[k] = freqBands[k-1] * 2; }   
    var freq = freqBands[k];
    console.log(freq); // log frequency bands
    return freq;
}

function setBqFreqBand(f){
    bandFilter.type = "bandpass";
    bandFilter.frequency.value = getBqFreqBands(f);
    bandFilter.Q.value = 29.7;
}

function freqData(m, aCtx){ 
    var bufferLength = aCtx.frequencyBinCount;
    var dataArray = new Float32Array(bufferLength);
    ('analyser' + m).getFloatFrequencyData(dataArray);
    var v = sum(dataArray[:]) / (bufferLength * 2);
    console.log(v*0.25);
    return v;
}

function setRect(n, analCtx){    
    var geometry = new THREE.CubeGeometry(10, -(freqData(n, analCtx)*0.1), 10);
    var material = new THREE.MeshBasicMaterial({
        color: 0x7777ff});
    var rect = new THREE.Mesh(geometry, material);
    rect.name = "rect-" + scene.children.length;
    rect.translateZ(n * 12.0);
    scene.add(rect);
}

function clearScene(scene) {
    var j;
    for (j = scene.children.length - 1; j >= 0; j--) {
        var obj = scene.children[j];
        if (obj instanceof THREE.Mesh && obj.type == "Mesh") {
            obj.geometry.dispose();
            obj.geometry = null;
            obj.material.dispose();
            obj.material = null;
            scene.remove( obj );
            obj = null;
        }
        else {
            if (obj.children !== undefined) {
                while (obj.children.length > 0) {
                    this.clearScene(obj.children[0]);
                    obj.remove(obj.children[0]);
                }
            }
        }
    }
}

function init() {
    camera = new THREE.PerspectiveCamera( 50, window.innerWidth / window.innerHeight, 100, 1000 );
    camera.position.set( 250, 250, 250 );
    
    // create an AudioListener and add it to the camera
    listener = new THREE.AudioListener();
    camera.add( listener );

    //analysisCtx = audioElement();

    renderer = new THREE.WebGLRenderer();
    renderer.setSize( window.innerWidth, window.innerHeight );

    // show cubes in an array
    var i;
    for(i=0; i<10; i++) {
        setRect(i, filterCtx);
        console.log(i);
    }

    // show axes in the screen
    var axes = new THREE.AxesHelper(2);
    scene.add(axes);

    var ambientLight = new THREE.AmbientLight(0x7777ff);
    scene.add(ambientLight);

    controls = new THREE.OrbitControls(camera);
    controls.rotateSpeed = 4;
}

init();
controls.update();
renderer.render(scene, camera);
frameLooper();

function frameLooper() {
    //renderer.autoClear = false;
    clearScene(scene);
    var l;
    for(l=0; l<10; l++) {
        setRect(l, analysisCtx);
    }
    requestAnimationFrame( frameLooper );
    controls.update();
    renderer.render( scene, camera );
}

document.getElementById('audio_box').appendChild(audio);
document.getElementById('container').appendChild(renderer.domElement);

</script>

</div>
</body>
</html>